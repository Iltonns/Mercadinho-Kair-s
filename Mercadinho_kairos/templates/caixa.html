{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-3">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1 text-gradient-primary">
                        <i class="fas fa-cash-register me-2"></i>Caixa R√°pido - PDV
                    </h1>
                    <p class="text-muted mb-0">Sistema de ponto de venda r√°pido e eficiente</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('vendas') }}" class="btn btn-gradient-info shadow-sm">
                        <i class="fas fa-receipt me-2"></i>Hist√≥rico de Vendas
                    </a>
                    <button class="btn btn-gradient-success shadow-lg" onclick="finalizarVenda()" id="btn-finalizar">
                        <i class="fas fa-check-circle me-2"></i>Finalizar Venda
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- COLUNA ESQUERDA - PRODUTOS E CARRINHO -->
        <div class="col-lg-8">
            <!-- BUSCAR PRODUTOS -->
            <div class="card border-0 shadow-lg mb-4">
                <div class="card-header bg-gradient-primary text-white py-3">
                    <h4 class="mb-0"><i class="fas fa-search me-2"></i>Buscar Produtos</h4>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label for="codigo-barras" class="form-label fw-semibold text-dark">
                                <i class="fas fa-barcode me-1 text-primary"></i>C√≥digo de Barras / Nome do Produto
                            </label>
                            <input type="text" class="form-control form-control-lg border-primary" 
                                   id="codigo-barras" placeholder="Passe o c√≥digo ou digite o nome..."
                                   autocomplete="off" autofocus>
                            <div class="form-text text-muted">
                                <i class="fas fa-info-circle me-1 text-info"></i>
                                Pressione Enter ou aguarde a busca autom√°tica
                            </div>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button class="btn btn-gradient-primary btn-lg w-100 shadow" onclick="buscarProduto()">
                                <i class="fas fa-search me-2"></i>Buscar
                            </button>
                        </div>
                    </div>

                    <!-- RESULTADOS DA BUSCA -->
                    <div id="resultados-busca" class="mt-3" style="display:none;">
                        <h6 class="text-dark fw-bold mb-3">
                            <i class="fas fa-list me-2 text-primary"></i>Resultados da Busca
                        </h6>
                        <div id="lista-resultados" class="list-group"></div>
                    </div>
                </div>
            </div>

            <!-- CARRINHO DE VENDA -->
            <div class="card border-0 shadow-lg">
                <div class="card-header bg-gradient-success text-white py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Carrinho de Venda</h4>
                        <span class="badge bg-light text-dark fs-6" id="badge-carrinho">0 itens</span>
                    </div>
                </div>
                <div class="card-body">
                    <!-- ESTADO VAZIO -->
                    <div id="carrinho-vazio" class="text-center py-5">
                        <i class="fas fa-shopping-cart fa-4x text-muted mb-3"></i>
                        <h5 class="text-muted">Carrinho Vazio</h5>
                        <p class="text-muted mb-4">Adicione produtos usando o c√≥digo de barras ou busca manual</p>
                        <div class="alert alert-info border-0 bg-info bg-opacity-10">
                            <i class="fas fa-lightbulb me-2 text-info"></i>
                            <strong>Dica:</strong> Passe o c√≥digo de barras ou digite o nome do produto
                        </div>
                    </div>

                    <!-- CARRINHO COM ITENS -->
                    <div id="carrinho-itens" style="display:none;">
                        <div class="table-responsive">
                            <table class="table table-hover table-striped" id="tabela-carrinho">
                                <thead class="table-success">
                                    <tr>
                                        <th width="35%" class="fw-semibold">Produto</th>
                                        <th width="15%" class="fw-semibold text-center">Pre√ßo Unit.</th>
                                        <th width="20%" class="fw-semibold text-center">Quantidade</th>
                                        <th width="15%" class="fw-semibold text-center">Subtotal</th>
                                        <th width="15%" class="fw-semibold text-center">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-carrinho"></tbody>
                            </table>
                        </div>

                        <!-- RESUMO DO CARRINHO -->
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="alert alert-info border-0 bg-info bg-opacity-10">
                                    <i class="fas fa-info-circle me-2 text-info"></i>
                                    <strong id="total-itens">0</strong> itens no carrinho
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <h3 class="text-success fw-bold">
                                    Total: R$ <span id="total-carrinho">0.00</span>
                                </h3>
                                <small class="text-muted">Valor total da venda</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- COLUNA DIREITA - INFORMA√á√ïES -->
        <div class="col-lg-4">
            <!-- CLIENTE -->
            <div class="card border-0 shadow-lg mb-4">
                <div class="card-header bg-gradient-info text-white py-3">
                    <h5 class="mb-0"><i class="fas fa-user me-2"></i>Informa√ß√µes do Cliente</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="cliente-venda" class="form-label fw-semibold text-dark">Cliente (Opcional)</label>
                        <select class="form-select border-primary" id="cliente-venda">
                            <option value="">-- Venda Avulsa --</option>
                            {% for cliente in clientes %}
                            <option value="{{ cliente.id }}">{{ cliente.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="alert alert-light border-0 bg-light">
                        <small class="text-muted">
                            <i class="fas fa-lightbulb me-1 text-warning"></i>
                            Cliente opcional para controle de hist√≥rico
                        </small>
                    </div>
                </div>
            </div>

            <!-- PAGAMENTO -->
            <div class="card border-0 shadow-lg mb-4">
                <div class="card-header bg-gradient-warning text-white py-3">
                    <h5 class="mb-0"><i class="fas fa-credit-card me-2"></i>Pagamento</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="forma-pagamento" class="form-label fw-semibold text-dark">Forma de Pagamento</label>
                        <select class="form-select border-primary" id="forma-pagamento" required>
                            <option value="dinheiro">üíµ Dinheiro</option>
                            <option value="cartao_debito">üí≥ Cart√£o D√©bito</option>
                            <option value="cartao_credito">üí≥ Cart√£o Cr√©dito</option>
                            <option value="pix">üì± PIX</option>
                        </select>
                    </div>

                    <!-- CAMPO DINHEIRO -->
                    <div id="campo-dinheiro">
                        <div class="mb-3">
                            <label for="valor-pago" class="form-label fw-semibold text-dark">Valor Entregue (R$)</label>
                            <input type="number" class="form-control border-primary" id="valor-pago"
                                   step="0.01" min="0" placeholder="0.00" value="0.00">
                        </div>
                        <!-- INFORMA√á√ïES DE TROCO E TOTAL -->
                        <div class="row mb-2">
                            <div class="col-6">
                                <div class="alert alert-success border-0 bg-success bg-opacity-10 py-2 mb-1 mb-lg-0" style="min-height: 56px;">
                                    <strong class="text-success">Troco:</strong>
                                    <span class="fw-bold text-success fs-6">R$ <span id="troco">0.00</span></span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="alert alert-info border-0 bg-info bg-opacity-10 py-2 mb-1 mb-lg-0" style="min-height: 56px;">
                                    <strong class="text-info">Total:</strong>
                                    <span class="fw-bold text-info fs-6">R$ <span id="total-carrinho-pagamento">0.00</span></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- BOT√ÉO FINALIZAR -->
                    <div class="d-grid mt-3">
                        <button class="btn btn-gradient-success btn-lg py-3 shadow" 
                                onclick="finalizarVenda()" id="btn-finalizar">
                            <i class="fas fa-check-circle me-2"></i>Finalizar Venda
                        </button>
                    </div>
                </div>
            </div>

            <!-- AJUDA R√ÅPIDA -->
            <div class="card border-0 shadow-lg">
                <div class="card-header bg-gradient-secondary text-white py-3">
                    <h5 class="mb-0"><i class="fas fa-question-circle me-2"></i>Ajuda R√°pida</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-primary border-0 bg-primary bg-opacity-10 mb-2">
                        <strong>üîç Busca R√°pida:</strong> Digite c√≥digo ou nome do produto
                    </div>
                    <div class="alert alert-warning border-0 bg-warning bg-opacity-10 mb-2">
                        <strong>‚öñÔ∏è Produtos Pes√°veis:</strong> Informe o peso quando solicitado
                    </div>
                    <div class="alert alert-info border-0 bg-info bg-opacity-10">
                        <strong>üí∞ Pagamento:</strong> Selecione a forma de pagamento
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL PESO -->
<div class="modal fade" id="modalPeso" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-gradient-warning text-white">
                <h5 class="modal-title">
                    <i class="fas fa-weight me-2"></i>Informe o Peso
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="info-produto-pesavel" class="alert alert-info border-0 bg-info bg-opacity-10"></div>
                <div class="mb-3">
                    <label for="peso-kg" class="form-label fw-semibold">Peso (kg)</label>
                    <input type="number" class="form-control border-primary" id="peso-kg"
                           step="0.001" min="0.001" placeholder="Ex: 1.250" autofocus>
                </div>
                <div class="alert alert-success border-0 bg-success bg-opacity-10">
                    <strong>Pre√ßo por kg:</strong> R$ <span id="preco-kg" class="fw-bold">0.00</span><br>
                    <strong>Total calculado:</strong> R$ <span id="total-calculado" class="fw-bold text-success fs-5">0.00</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-gradient-success" onclick="adicionarProdutoPesavel()">
                    <i class="fas fa-cart-plus me-2"></i>Adicionar ao Carrinho
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL CONFIRMA√á√ÉO -->
<div class="modal fade" id="modalConfirmacao" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-gradient-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>Venda Finalizada!
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
                <h4 class="text-success mb-3">Venda realizada com sucesso!</h4>
                <p id="mensagem-sucesso" class="lead text-muted">Obrigado pela prefer√™ncia!</p>
                <div class="alert alert-info border-0 bg-info bg-opacity-10">
                    <strong>N¬∫ da Venda:</strong> 
                    <span id="numero-venda" class="fw-bold fs-5">#000</span>
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-gradient-primary" onclick="imprimirRecibo()">
                    <i class="fas fa-print me-2"></i>Imprimir Recibo
                </button>
                <button type="button" class="btn btn-gradient-success" onclick="novaVenda()">
                    <i class="fas fa-plus me-2"></i>Nova Venda
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL CARREGAMENTO -->
<div class="modal fade" id="modalCarregamento" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-sm">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-body text-center py-4 bg-gradient-primary text-white rounded">
                <div class="spinner-border spinner-border-lg text-white mb-3" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <h6 class="text-white">Processando...</h6>
                <p class="text-white mb-0 opacity-75" id="modal-mensagem">Aguarde</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
/* =======================================================
   VARI√ÅVEIS GLOBAIS
   ======================================================= */
let carrinho = [];
let produtoPesavelAtual = null;


/* =======================================================
   INICIALIZA√á√ÉO - VERS√ÉO CORRIGIDA
   ======================================================= */
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîÑ Inicializando caixa...');
    
    // Verificar se elementos essenciais existem
    const elementosEssenciais = [
        'codigo-barras', 'resultados-busca', 'lista-resultados',
        'carrinho-vazio', 'carrinho-itens', 'tbody-carrinho'
    ];
    
    elementosEssenciais.forEach(id => {
        if (!document.getElementById(id)) {
            console.error(`‚ùå Elemento essencial n√£o encontrado: ${id}`);
        }
    });
    
    // Configurar eventos
    configurarEventos();
    
    // Inicializar interface
    toggleCampoDinheiro();
    calcularTroco();
    atualizarCarrinho();
    
    // Focar no campo de c√≥digo de barras
    setTimeout(() => {
        const campoCodigo = document.getElementById('codigo-barras');
        if (campoCodigo) {
            campoCodigo.focus();
        } else {
            console.error('‚ùå Campo c√≥digo de barras n√£o encontrado');
        }
    }, 500);
    
    console.log('‚úÖ Caixa inicializado');
});

/* =======================================================
   BUSCA DE PRODUTOS - VERS√ÉO CORRIGIDA
   ======================================================= */
async function buscarProdutoAuto(termo) {
    if (!termo || termo.length < 2) {
        ocultarResultadosBusca();
        return;
    }
    
    console.log(`üîç Buscando: "${termo}"`);
    
    try {
        const response = await fetch('/caixa/buscar_auto', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ codigo: termo })
        });

        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }

        const data = await response.json();
        console.log('üì¶ Resposta busca:', data);

        if (data.success) {
            ocultarResultadosBusca();
            
            if (data.pesavel) {
                // Produto pes√°vel - abrir modal de peso
                abrirModalPeso(data.produto);
                limparCampoBusca(false);
            } else if (data.adicionar_carrinho && data.produto) {
                // Produto normal - adicionar diretamente ao carrinho
                adicionarAoCarrinho(data.produto, data.quantidade || 1);
                mostrarNotificacao(`‚úÖ ${data.produto.nome} adicionado ao carrinho!`, 'success');
                limparCampoBusca(true);
            } else if (data.produtos && data.produtos.length > 0) {
                // M√∫ltiplos resultados - mostrar lista
                mostrarResultadosBusca(data.produtos);
                limparCampoBusca(false);
            } else {
                mostrarNotificacao(`‚ùå Produto n√£o encontrado`, 'warning');
                limparCampoBusca(true);
            }
        } else {
            mostrarNotificacao(`‚ùå ${data.message || 'Produto n√£o encontrado'}`, 'warning');
            ocultarResultadosBusca();
        }
    } catch (error) {
        console.error('‚ùå Erro na busca:', error);
        mostrarNotificacao('‚ùå Erro na busca. Tente novamente.', 'danger');
    }
}

function buscarProduto() {
    const termo = document.getElementById('codigo-barras').value.trim();
    if (!termo) {
        mostrarNotificacao('‚ö†Ô∏è Digite um c√≥digo ou nome para buscar', 'warning');
        return;
    }
    buscarProdutoAuto(termo);
}

// CORRE√á√ÉO: Fun√ß√£o para ocultar resultados
function ocultarResultadosBusca() {
    const container = document.getElementById('resultados-busca');
    if (container) {
        container.style.display = 'none';
    }
}

// CORRE√á√ÉO: Fun√ß√£o para mostrar resultados (par√¢metro corrigido)
function mostrarResultadosBusca(produtos) {
    const container = document.getElementById('resultados-busca');
    const lista = document.getElementById('lista-resultados');
    
    if (!container || !lista) {
        console.error('‚ùå Elementos DOM n√£o encontrados para mostrar resultados');
        return;
    }
    
    if (!produtos || produtos.length === 0) {
        lista.innerHTML = '<div class="list-group-item text-muted text-center">Nenhum produto encontrado</div>';
        container.style.display = 'block';
        return;
    }
    
    // CORRE√á√ÉO: Template seguro para produtos
    lista.innerHTML = produtos.map(produto => {
        const produtoSeguro = {
            id: produto.id || 0,
            nome: produto.nome || 'Produto sem nome',
            codigo_barras: produto.codigo_barras || 'N/A',
            quantidade: produto.quantidade || 0,
            preco: produto.preco || 0
        };
        
        return `
        <div class="list-group-item list-group-item-action">
            <div class="d-flex w-100 justify-content-between align-items-center">
                <div>
                    <h6 class="mb-1 text-dark">${produtoSeguro.nome}</h6>
                    <small class="text-muted">
                        üìã ${produtoSeguro.codigo_barras} | 
                        üì¶ Estoque: ${produtoSeguro.quantidade}
                    </small>
                </div>
                <div class="text-end">
                    <div class="fw-bold text-success">R$ ${parseFloat(produtoSeguro.preco).toFixed(2)}</div>
                    <button class="btn btn-sm btn-gradient-primary mt-1"
                            onclick="adicionarAoCarrinho(${produtoSeguro.id}, '${produtoSeguro.nome.replace(/'/g, "\\'")}', ${produtoSeguro.preco})">
                        <i class="fas fa-cart-plus me-1"></i>Add
                    </button>
                </div>
            </div>
        </div>
        `;
    }).join('');
    
    container.style.display = 'block';
}

// CORRE√á√ÉO: Fun√ß√£o auxiliar para adicionar produto simples
function adicionarProdutoSimples(id, nome, preco) {
    const produto = {
        id: id,
        nome: nome,
        preco: parseFloat(preco),
        quantidade: 1,
        subtotal: parseFloat(preco),
        pesavel: false
    };
    adicionarAoCarrinho(produto);
}


/* =======================================================
   MODAL PES√ÅVEL
   ======================================================= */
function abrirModalPeso(produto) {
    produtoPesavelAtual = produto;
    
    document.getElementById('info-produto-pesavel').innerHTML = `
        <strong>üçé Produto:</strong> ${produto.nome}<br>
        <strong>üìã C√≥digo:</strong> ${produto.codigo_personalizado || produto.codigo_barras || '‚Äî'}
    `;
    
    const precoKgElem = document.getElementById('preco-kg');
    if (precoKgElem) precoKgElem.textContent = parseFloat(produto.preco_por_kg || produto.preco || 0).toFixed(2);
    
    const totalCalculadoElem = document.getElementById('total-calculado');
    if (totalCalculadoElem) totalCalculadoElem.textContent = '0.00';
    
    const campoPeso = document.getElementById('peso-kg');
    if (campoPeso) {
        campoPeso.value = '';
        campoPeso.focus();
    }
    
    const modal = new bootstrap.Modal(document.getElementById('modalPeso'));
    modal.show();
}

function calcularTotalPesavel() {
    if (!produtoPesavelAtual) return;
    
    const peso = parseFloat(document.getElementById('peso-kg').value.replace(',', '.')) || 0;
    const precoKg = parseFloat(produtoPesavelAtual.preco_por_kg || produtoPesavelAtual.preco || 0);
    const total = peso * precoKg;
    
    const totalCalculadoElem = document.getElementById('total-calculado');
    if (totalCalculadoElem) totalCalculadoElem.textContent = total.toFixed(2);
}

function adicionarProdutoPesavel() {
    const peso = parseFloat(document.getElementById('peso-kg').value.replace(',', '.')) || 0;
    
    if (peso <= 0) {
        mostrarNotificacao('‚ùå Informe um peso v√°lido (maior que zero)', 'danger');
        return;
    }
    
    if (!produtoPesavelAtual) {
        mostrarNotificacao('‚ùå Erro: produto n√£o encontrado', 'danger');
        return;
    }
    
    const precoUnitario = produtoPesavelAtual.preco_por_kg || produtoPesavelAtual.preco || 0;
    const totalItem = peso * precoUnitario;
    
    if (totalItem <= 0) {
        mostrarNotificacao('‚ùå Erro no c√°lculo do valor', 'danger');
        return;
    }
    
    const produtoComPeso = {
        id: produtoPesavelAtual.id,
        nome: produtoPesavelAtual.nome,
        preco: precoUnitario,
        quantidade: peso,
        subtotal: totalItem,
        pesavel: true,
        peso_kg: peso,
        codigo_personalizado: produtoPesavelAtual.codigo_personalizado,
        codigo_barras: produtoPesavelAtual.codigo_barras
    };
    
    adicionarAoCarrinho(produtoComPeso);
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalPeso'));
    if (modal) modal.hide();
    
    limparCampoBusca();
    produtoPesavelAtual = null;
    
    mostrarNotificacao(`‚úÖ ${produtoComPeso.nome} (${peso.toFixed(3)}kg) adicionado!`, 'success');
}

/* =======================================================
   GERENCIAMENTO DO CARRINHO
   ======================================================= */
function adicionarAoCarrinho(produto, quantidade = 1) {
    // Para produtos pes√°veis, sempre adiciona como novo item
    if (produto.pesavel) {
        carrinho.push({...produto});
    } else {
        // Para produtos normais, verifica se j√° existe no carrinho
        const itemExistente = carrinho.find(item => 
            item.id === produto.id && !item.pesavel
        );
        
        if (itemExistente) {
            // Incrementa quantidade do item existente
            itemExistente.quantidade += quantidade;
            itemExistente.subtotal = itemExistente.quantidade * itemExistente.preco;
        } else {
            // Adiciona novo item
            carrinho.push({
                id: produto.id,
                nome: produto.nome,
                preco: produto.preco,
                quantidade: quantidade,
                subtotal: quantidade * produto.preco,
                pesavel: false,
                codigo_barras: produto.codigo_barras,
                codigo_personalizado: produto.codigo_personalizado
            });
        }
    }
    
    atualizarCarrinho();
    ocultarResultadosBusca();
}

function removerDoCarrinho(index) {
    if (index >= 0 && index < carrinho.length) {
        const produto = carrinho[index];
        carrinho.splice(index, 1);
        atualizarCarrinho();
        mostrarNotificacao(`üóëÔ∏è ${produto.nome} removido do carrinho`, 'info');
    }
}

function atualizarQuantidade(index, novaQuantidade) {
    if (index < 0 || index >= carrinho.length) return;
    
    const item = carrinho[index];
    if (item.pesavel) return; // N√£o altera quantidade de produtos pes√°veis
    
    let qtd = parseInt(novaQuantidade);
    if (isNaN(qtd) || qtd < 1) qtd = 1;
    
    item.quantidade = qtd;
    item.subtotal = item.quantidade * item.preco;
    atualizarCarrinho();
}

function atualizarCarrinho() {
    const tbody = document.getElementById('tbody-carrinho');
    const carrinhoVazio = document.getElementById('carrinho-vazio');
    const carrinhoItens = document.getElementById('carrinho-itens');
    const badgeCarrinho = document.getElementById('badge-carrinho');
    
    if (!tbody || !carrinhoVazio || !carrinhoItens) return;
    
    // Carrinho vazio
    if (carrinho.length === 0) {
        carrinhoVazio.style.display = 'block';
        carrinhoItens.style.display = 'none';
        if (badgeCarrinho) badgeCarrinho.textContent = '0 itens';
        
        const totalCarrinhoElem = document.getElementById('total-carrinho');
        if (totalCarrinhoElem) totalCarrinhoElem.textContent = '0.00';
        
        const totalItensElem = document.getElementById('total-itens');
        if (totalItensElem) totalItensElem.textContent = '0';
        
        calcularTroco();
        return;
    }
    
    // Carrinho com itens
    carrinhoVazio.style.display = 'none';
    carrinhoItens.style.display = 'block';
    
    // Atualizar badge
    if (badgeCarrinho) {
        badgeCarrinho.textContent = `${carrinho.length} ${carrinho.length === 1 ? 'item' : 'itens'}`;
    }
    
    // Renderizar itens
    tbody.innerHTML = carrinho.map((item, index) => `
        <tr>
            <td>
                <strong class="text-dark">${item.nome}</strong>
                ${item.pesavel ? 
                    `<br><small class="text-muted">‚öñÔ∏è Pes√°vel ‚Ä¢ ${parseFloat(item.quantidade).toFixed(3)}kg</small>` : 
                    ''
                }
                ${item.codigo_personalizado ? 
                    `<br><small class="text-muted">üìã C√≥d: ${item.codigo_personalizado}</small>` : 
                    ''
                }
            </td>
            <td class="text-center fw-bold text-success">
                R$ ${parseFloat(item.preco).toFixed(2)}
            </td>
            <td class="text-center">
                ${item.pesavel ? 
                    `<span class="badge bg-info fs-6">${parseFloat(item.quantidade).toFixed(3)}kg</span>` :
                    `<div class="input-group input-group-sm justify-content-center">
                        <button class="btn btn-outline-danger" 
                                onclick="atualizarQuantidade(${index}, ${item.quantidade - 1})"
                                ${item.quantidade <= 1 ? 'disabled' : ''}>-</button>
                        <input type="number" class="form-control text-center" 
                               value="${item.quantidade}" 
                               onchange="atualizarQuantidade(${index}, this.value)"
                               style="max-width: 70px;">
                        <button class="btn btn-outline-success" 
                                onclick="atualizarQuantidade(${index}, ${item.quantidade + 1})">+</button>
                     </div>`
                }
            </td>
            <td class="text-center fw-bold text-primary fs-6">
                R$ ${parseFloat(item.subtotal).toFixed(2)}
            </td>
            <td class="text-center">
                <button class="btn btn-sm btn-gradient-danger" 
                        onclick="removerDoCarrinho(${index})"
                        title="Remover item">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
    
    // Calcular totais
    const total = carrinho.reduce((sum, item) => sum + parseFloat(item.subtotal || 0), 0);

    // Atualiza o total no card de pagamento
    const totalPagamentoElem = document.getElementById('total-carrinho-pagamento');
    if (totalPagamentoElem) totalPagamentoElem.textContent = total.toFixed(2);
    
    const totalCarrinhoElem = document.getElementById('total-carrinho');
    if (totalCarrinhoElem) totalCarrinhoElem.textContent = total.toFixed(2);
    
    const totalItensElem = document.getElementById('total-itens');
    if (totalItensElem) totalItensElem.textContent = carrinho.length;
    
    calcularTroco();
}

/* =======================================================
   PAGAMENTO E TROCO
   ======================================================= */
function toggleCampoDinheiro() {
    const formaPagamento = document.getElementById('forma-pagamento').value;
    const campoDinheiro = document.getElementById('campo-dinheiro');
    
    if (campoDinheiro) {
        campoDinheiro.style.display = formaPagamento === 'dinheiro' ? 'block' : 'none';
    }
    
    if (formaPagamento === 'dinheiro') {
        calcularTroco();
    }
}

function calcularTroco() {
    const total = carrinho.reduce((sum, item) => sum + parseFloat(item.subtotal || 0), 0);
    const formaPagamento = document.getElementById('forma-pagamento').value;
    
    const trocoElem = document.getElementById('troco');
    
    if (formaPagamento === 'dinheiro') {
        const valorPago = parseFloat(document.getElementById('valor-pago').value.replace(',', '.')) || 0;
        const troco = Math.max(valorPago - total, 0);
        if (trocoElem) trocoElem.textContent = troco.toFixed(2);
    } else {
        if (trocoElem) trocoElem.textContent = '0.00';
    }
}

/* =======================================================
   FINALIZA√á√ÉO DA VENDA
   ======================================================= */
async function finalizarVenda() {
    if (carrinho.length === 0) {
        mostrarNotificacao('‚ö†Ô∏è Adicione produtos ao carrinho antes de finalizar', 'warning');
        return;
    }
    
    const formaPagamento = document.getElementById('forma-pagamento').value;
    const clienteId = document.getElementById('cliente-venda').value || null;
    const total = carrinho.reduce((sum, item) => sum + parseFloat(item.subtotal || 0), 0);
    
    let valorPago = total;
    let troco = 0;
    
    // Validar pagamento em dinheiro
    if (formaPagamento === 'dinheiro') {
        valorPago = parseFloat(document.getElementById('valor-pago').value.replace(',', '.')) || 0;
        if (valorPago < total) {
            mostrarNotificacao('‚ùå Valor pago insuficiente!', 'danger');
            return;
        }
        troco = valorPago - total;
    }
    
    // Preparar dados da venda
    const dadosVenda = {
        itens: carrinho,
        total: total,
        forma_pagamento: formaPagamento,
        valor_pago: valorPago,
        troco: troco,
        cliente_id: clienteId
    };
    
    console.log('üí∞ Dados da venda:', dadosVenda);
    
    // Desabilitar bot√£o
    const btnFinalizar = document.getElementById('btn-finalizar');
    const textoOriginal = btnFinalizar.innerHTML;
    btnFinalizar.disabled = true;
    btnFinalizar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processando...';
    
    try {
        
        const response = await fetch('/caixa/finalizar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                cliente_id: clienteId,
                itens: carrinho,
                total: total,
                forma_pagamento: formaPagamento,
                valor_pago: valorPago,
                troco: troco
            })
        });
        
        const data = await response.json();
        ocultarModalCarregamento();
        
        if (data.success) {
            // Sucesso - mostrar confirma√ß√£o
            const numeroVendaElem = document.getElementById('numero-venda');
            if (numeroVendaElem) numeroVendaElem.textContent = `#${data.venda_id}`;
            const modal = new bootstrap.Modal(document.getElementById('modalConfirmacao'));
            modal.show();
            
            console.log('‚úÖ Venda finalizada:', data.venda_id);
        } else {
            // Erro
            mostrarNotificacao(`‚ùå ${data.message || 'Erro ao finalizar venda'}`, 'danger');
        }
    } catch (error) {
        console.error('‚ùå Erro na finaliza√ß√£o:', error);
        ocultarModalCarregamento();
        mostrarNotificacao('‚ùå Erro de conex√£o. Tente novamente.', 'danger');
    } finally {
        // Reabilitar bot√£o
        btnFinalizar.disabled = false;
        btnFinalizar.innerHTML = textoOriginal;
    }
}

/* =======================================================
   CORRE√á√ÉO DA FUN√á√ÉO configurarEventos
   ======================================================= */
function configurarEventos() {
    // Busca autom√°tica - CORRE√á√ÉO: Verifica√ß√£o de elemento
    const campoCodigo = document.getElementById('codigo-barras');
    if (campoCodigo) {
        let timeoutBusca;
        campoCodigo.addEventListener('input', function() {
            clearTimeout(timeoutBusca);
            const termo = this.value.trim();
            if (termo.length >= 2) {
                timeoutBusca = setTimeout(() => buscarProdutoAuto(termo), 300);
            } else if (termo.length === 0) {
                ocultarResultadosBusca();
            }
        });
        
        campoCodigo.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                buscarProdutoAuto(this.value.trim());
            }
        });
    } else {
        console.error('‚ùå Campo de busca n√£o encontrado para configurar eventos');
    }

    // Eventos de pagamento - CORRE√á√ÉO: Verifica√ß√£o de elementos
    const formaPagamento = document.getElementById('forma-pagamento');
    if (formaPagamento) {
        formaPagamento.addEventListener('change', function() {
            toggleCampoDinheiro();
            calcularTroco();
        });
    }

    const valorPago = document.getElementById('valor-pago');
    if (valorPago) {
        valorPago.addEventListener('input', calcularTroco);
        valorPago.addEventListener('change', calcularTroco);
    }

    // Evento de peso - CORRE√á√ÉO: Verifica√ß√£o de elemento
    const pesoKg = document.getElementById('peso-kg');
    if (pesoKg) {
        pesoKg.addEventListener('input', calcularTotalPesavel);
    }
}

/* =======================================================
   FUN√á√ïES AUXILIARES
   ======================================================= */
function mostrarResultadosBusca(produtos, mensagem) {
    const container = document.getElementById('resultados-busca');
    const lista = document.getElementById('lista-resultados');
    
    if (!container || !lista) return;
    
    if (!produtos || produtos.length === 0) {
        lista.innerHTML = '<div class="list-group-item text-muted">Nenhum produto encontrado</div>';
        container.style.display = 'block';
        return;
    }
    
    lista.innerHTML = produtos.map(produto => `
        <div class="list-group-item list-group-item-action">
            <div class="d-flex w-100 justify-content-between align-items-center">
                <div>
                    <h6 class="mb-1 text-dark">${produto.nome}</h6>
                    <small class="text-muted">
                        üìã ${produto.codigo_barras || 'N/A'} | 
                        üì¶ Estoque: ${produto.quantidade || 0}
                    </small>
                </div>
                <div class="text-end">
                    <div class="fw-bold text-success">R$ ${parseFloat(produto.preco).toFixed(2)}</div>
                    <button class="btn btn-sm btn-gradient-primary mt-1"
                            onclick='adicionarAoCarrinho(${JSON.stringify(produto).replace(/'/g, "\\'")}, 1)'>
                        <i class="fas fa-cart-plus me-1"></i>Add
                    </button>
                </div>
            </div>
        </div>
    `).join('');
    
    container.style.display = 'block';
}

function novaVenda() {
    carrinho = [];
    
    // Limpar campos
    const codigoBarrasElem = document.getElementById('codigo-barras');
    if (codigoBarrasElem) codigoBarrasElem.value = '';
    
    const clienteVendaElem = document.getElementById('cliente-venda');
    if (clienteVendaElem) clienteVendaElem.value = '';
    
    const formaPagamentoElem = document.getElementById('forma-pagamento');
    if (formaPagamentoElem) formaPagamentoElem.value = 'dinheiro';
    
    const valorPagoElem = document.getElementById('valor-pago');
    if (valorPagoElem) valorPagoElem.value = '0.00';
    
    // Atualizar interface
    atualizarCarrinho();
    toggleCampoDinheiro();
    calcularTroco();
    
    // Fechar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalConfirmacao'));
    if (modal) modal.hide();
    
    // Focar no campo de busca
    if (codigoBarrasElem) codigoBarrasElem.focus();
    
    mostrarNotificacao('üîÑ Nova venda iniciada', 'info');
}

function imprimirRecibo() {
    const numeroVendaElem = document.getElementById('numero-venda');
    const numeroVenda = numeroVendaElem ? numeroVendaElem.textContent.replace('#', '') : null;
    if (numeroVenda && numeroVenda !== '000') {
        window.open(`/recibo/${numeroVenda}`, '_blank');
    }
}

function mostrarModalCarregamento(mensagem = 'Processando...') {
    const modalMensagem = document.getElementById('modal-mensagem');
    if (modalMensagem) modalMensagem.textContent = mensagem;
    
    const modal = new bootstrap.Modal(document.getElementById('modalCarregamento'));
    modal.show();
}

function ocultarModalCarregamento() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalCarregamento'));
    if (modal) modal.hide();
}

function mostrarNotificacao(mensagem, tipo) {
    // Remover notifica√ß√µes antigas
    const notificacoesAntigas = document.querySelectorAll('.alert-notificacao');
    notificacoesAntigas.forEach(notif => notif.remove());
    
    const alerta = document.createElement('div');
    alerta.className = `alert alert-${tipo} alert-dismissible fade show alert-notificacao shadow`;
    alerta.style.position = 'fixed';
    alerta.style.top = '20px';
    alerta.style.right = '20px';
    alerta.style.zIndex = '1060';
    alerta.style.minWidth = '350px';
    
    alerta.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${tipo === 'success' ? 'check-circle' : tipo === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'} me-2 fs-5"></i>
            <div class="flex-grow-1">${mensagem}</div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    document.body.appendChild(alerta);
    
    // Auto-remover ap√≥s 5 segundos
    setTimeout(() => {
        if (alerta.parentNode) {
            alerta.remove();
        }
    }, 5000);
}

/* =======================================================
   CORRE√á√ÉO DA FUN√á√ÉO limparCampoBusca
   ======================================================= */
function limparCampoBusca(focar = true) {
    const campo = document.getElementById('codigo-barras');
    if (campo) {
        campo.value = '';
        if (focar) {
            setTimeout(() => campo.focus(), 100);
        }
    }
}
</script>

<style>
:root {
    --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --gradient-success: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
    --gradient-warning: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --gradient-info: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --gradient-danger: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    --gradient-secondary: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
}

/* Gradientes para bot√µes */
.btn-gradient-primary { background: var(--gradient-primary); border: none; color: white; }
.btn-gradient-success { background: var(--gradient-success); border: none; color: white; }
.btn-gradient-warning { background: var(--gradient-warning); border: none; color: white; }
.btn-gradient-info { background: var(--gradient-info); border: none; color: white; }
.btn-gradient-danger { background: var(--gradient-danger); border: none; color: white; }
.btn-gradient-secondary { background: var(--gradient-secondary); border: none; color: white; }

.btn-gradient-primary:hover { 
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%); 
    color: white;
    transform: translateY(-2px);
}

/* Cards com gradientes */
.bg-gradient-primary { background: var(--gradient-primary) !important; }
.bg-gradient-success { background: var(--gradient-success) !important; }
.bg-gradient-warning { background: var(--gradient-warning) !important; }
.bg-gradient-info { background: var(--gradient-info) !important; }
.bg-gradient-danger { background: var(--gradient-danger) !important; }
.bg-gradient-secondary { background: var(--gradient-secondary) !important; }

.text-gradient-primary { 
    background: var(--gradient-primary); 
    -webkit-background-clip: text; 
    -webkit-text-fill-color: transparent; 
    font-weight: 700;
}

/* Melhorias visuais */
.card { border-radius: 1rem; border: none; }
.shadow-lg { box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.1) !important; }
.form-control-lg { border-radius: 0.75rem; padding: 0.75rem 1rem; }
.form-select { border-radius: 0.75rem; }

/* Tabelas */
.table-hover tbody tr:hover { background-color: rgba(0, 123, 255, 0.04); }
.table-success thead { background: var(--gradient-success) !important; color: white; }

/* Input group personalizado */
.input-group-sm .btn { padding: 0.25rem 0.5rem; }
.input-group-sm .form-control { padding: 0.25rem 0.5rem; }

/* List group personalizado */
.list-group-item { border: 1px solid rgba(0,0,0,0.05); margin-bottom: 0.25rem; border-radius: 0.5rem !important; }
.list-group-item:hover { background-color: #f8f9fa; transform: translateX(2px); transition: all 0.2s; }

/* Badges */
.badge { font-weight: 600; padding: 0.5em 0.75em; }

/* Anima√ß√µes */
@keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.alert-notificacao {
    animation: slideInRight 0.5s ease;
    border: none;
    border-radius: 0.75rem;
}

/* Responsividade */
@media (max-width: 768px) {
    .btn-lg { padding: 0.75rem 1rem; font-size: 0.875rem; }
    .form-control-lg { padding: 0.5rem 0.75rem; font-size: 0.875rem; }
    .card-body { padding: 1rem; }
}

/* Foco visual melhorado */
.form-control:focus, .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

/* Modal improvements */
.modal-content { border-radius: 1rem; }
.modal-header { border-bottom: none; padding-bottom: 0; }

/* Carrinho vazio styling */
#carrinho-vazio { 
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 1rem;
}
</style>
{% endblock %}